

 @using ShopApp.Core
@using MudBlazor
@using ShopApp.UseCases.Services
@inject HttpClient Http
@implements IDisposable

<MudDialog>
    <DialogContent>
        <EditForm Model="book" OnValidSubmit="Save">
            <DataAnnotationsValidator />
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="book.Title"
                                  Label="Title"
                                  Variant="Variant.Outlined"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="book.Author"
                                  Label="Author"
                                  Variant="Variant.Outlined"
                                  Required="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="book.Price"
                                  Label="Price"
                                  InputType="InputType.Number"
                                  Variant="Variant.Outlined"
                                  Required="true" />
                </MudItem>

                
                <MudItem xs="12">
                    <MudSelect T="string" Label="Category" @bind-Value="book.CategoryId" Variant="Variant.Outlined" Required="true">
                @foreach (var cat in categories)
                {
                            <MudSelectItem Value="@cat.Id">@cat.Name</MudSelectItem>
                }
                    </MudSelect>
                </MudItem>
                
            </MudGrid>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Save" Variant="Variant.Filled" Color="Color.Primary">Save</MudButton>
        <MudButton OnClick="Cancel" Variant="Variant.Filled">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Guid Id { get; set; }

    [Parameter]
    public Func<Task>? Callback { get; set; }

    // Model
    public Book book = new();

    // Categories
    private List<Category> categories = new();

    // Flag to avoid "ObjectDisposedException"
    private bool _disposed;

    // Cancel the dialog
    void Cancel() => MudDialog.Cancel();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load categories if needed
            categories = await Http.GetFromJsonAsync<List<Category>>("api/category") ?? new();

            if (Id != Guid.Empty)
            {
                // Edit mode
                var existingBook = await Http.GetFromJsonAsync<Book>($"api/book/{Id}");
                book = existingBook ?? new Book();
                Console.WriteLine($"[AddEditBookDialog] Editing Book: {book.Id}, Title={book.Title}");
            }
            else
            {
                // Add mode
                Console.WriteLine("[AddEditBookDialog] New Book mode");
                book = new Book
                    {
                    // Preselect a category if needed
                        CategoryId = categories.FirstOrDefault()?.Id ?? string.Empty
                    };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($" Error initializing dialog: {ex.Message}");
        }
    }

    private async Task Save()
    {
        try
        {
            // Avoid operations if already disposed
            if (_disposed) return;

            if (Id != Guid.Empty)
            {
                // PUT request
                Console.WriteLine($"[AddEditBookDialog] Updating book {book.Id}");
                await Http.PutAsJsonAsync($"api/book/{book.Id}", book);
            }
            else
            {
                // POST request
                Console.WriteLine("[AddEditBookDialog] Creating new book");
                await Http.PostAsJsonAsync("api/book", book);
            }

            // Invoke callback for refresh
            if (Callback != null)
                await Callback.Invoke();

            // Close the dialog
            MudDialog.Close();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[AddEditBookDialog] Error on save: {ex.Message}");
        }
    }

    // Proper implementation of IDisposable
    public void Dispose()
    {
        _disposed = true;
        Console.WriteLine("[AddEditBookDialog] Disposing resources...");
    }
}

